{% extends 'admin/cityView.html' %} {% block head_tail %} {{ super() }}

<script src="http://cdnjs.cloudflare.com/ajax/libs/jquery/2.0.3/jquery.js"></script>
<script src="http://cdnjs.cloudflare.com/ajax/libs/jquery.address/1.6/jquery.address.js"></script>
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>

<script type="text/javascript" src="/static/javascript/jquery.tablesorter.js"></script>

<style type="text/css">
#POSInfo {
  float: left;
  width: 100%;
  height: 100%;
  overflow: auto;
}
</style>

{% endblock %} {% block body %}

<script type='text/javascript'>
var xmlData = "";
var pointOfServer = [];
var region = [];
$(document).ready(function() {
  $("#POSInfo").hide();
  var xmlhttp;
  if (window.XMLHttpRequest) { // code for IE7+, Firefox, Chrome, Opera, Safari
    xmlhttp = new XMLHttpRequest();
  } else { // code for IE6, IE5
    xmlhttp = new ActiveXObject("Microsoft.XMLHTTP");
  }
  xmlhttp.onreadystatechange = function() {
    if (xmlhttp.readyState == 4 && xmlhttp.status == 200) {
      var regionInfo = xmlhttp.responseText;
      var obj = eval("(" + regionInfo + ")");
      for (var i = 0; i < obj.regionInfo.length; i++) {
        var area = new Object();
        area.district = obj.regionInfo[i].District;
        area.postalCode = obj.regionInfo[i].Code;
        region.push(area);
      }
    }
  }
  xmlhttp.open("POST", "http://140.109.22.197/getCode/", true);
  xmlhttp.send();
});

function NextStep() {
  for (var i = 0; i < pointOfServer.length; i++) {
    posData = "POSServer$" + GetPOSInfo(i);
    var hr = new XMLHttpRequest();
    var serverUrl = "http://140.109.22.197/admin/postPOSInfo/";
    hr.open("POST", serverUrl, true);
    hr.send(posData);
  }
  setTimeout('window.location.replace("http://140.109.22.197/admin/")', 2000);
}

function LoadFileAsText() {
  var fileToLoad = document.getElementById("fileToLoad").files[0];

  var fileReader = new FileReader();
  fileReader.onload = function(fileLoadedEvent) {
    var textFromFileLoaded = fileLoadedEvent.target.result;
    document.getElementById("inputTextToSave").value = textFromFileLoaded;
    xmlData = textFromFileLoaded;
  };
  fileReader.readAsText(fileToLoad, "UTF-8");
}

function ShowPOSInfo() {
  $("#POSInfo").show();
  $("#countryCode").hide();
  if (window.DOMParser) {
    parser = new DOMParser();
    xmlDoc = parser.parseFromString(xmlData, "text/xml");
  } else // Internet Explorer
  {
    xmlDoc = new ActiveXObject("Microsoft.XMLDOM");
    xmlDoc.async = false;
    xmlDoc.loadXML(xmlData);
  }
  var num = 0;
  for (var i = 0; i < xmlDoc.getElementsByTagName("POSSite").length; i =
    i + 5) {
    var pos = new Object();
    pos.myward = xmlDoc.getElementsByTagName("District")[i].childNodes[0].nodeValue;
    pos.special_id = document.getElementById('nationCode').value + "-" +
      GetCode(pos.myward) + "-" + RandomNum();
    pos.lat = xmlDoc.getElementsByTagName("Latitude")[i].childNodes[0].nodeValue;
    pos.lng = xmlDoc.getElementsByTagName("Longitude")[i].childNodes[0].nodeValue;
    pointOfServer.push(pos);

    num++;

    BuildPOSTable(pos.special_id, pos.myward, pos.lat, pos.lng, num);
  }
}

function GetCode(district) {
  for (var j = 0; j < region.length; j++) {
    if (district == region[j].district) {
      return region[j].postalCode;
    }
  }
}

function BuildPOSTable(id, area, x, y, rowCounts) {
  var tr = $("<tr></tr>").addClass("dynamic_tr").attr("id", "trNo" + rowCounts);

  var td_name = $('<td></td>').text(id).attr("id", "tdName" + rowCounts);
  tr.append(td_name);

  var td_area = $('<td></td>').text(area).attr("id", "td_area" + rowCounts);
  tr.append(td_area);

  var td_lat = $('<td></td>').text(x).attr("id", "td_lat" + rowCounts);
  tr.append(td_lat);

  var td_lng = $('<td></td>').text(y).attr("id", "td_lng" + rowCounts);
  tr.append(td_lng);

  $("#POSTable").append(tr);
  $('#POSTable').tablesorter();
}


function GetPOSInfo(num) {
  nationCode = document.getElementById('nationCode').value;
  allText = nationCode + '$' + pointOfServer[num].special_id + '$' +
    pointOfServer[num].myward + '$' + pointOfServer[num].lat + '$' +
    pointOfServer[num].lng;

  return allText;
}

function RandomNum() {
  var digit = ""
  for (var i = 0; i < 6; i++) {
    digit += Math.floor(Math.random() * 10);
  }
  return digit;
}
</script>
<h2 class="ui header" id="header">Create POS configuration</h2>
<div id="setupnext" class="ui blue button" style="float: right" onclick="NextStep()">Next</div>
<div style="float: right">&nbsp</div>
<div id="setupback" class="ui blue button" style="float: right" onclick="">Back</div>

<div class="ui celled grid" style="width:100%;height:100%">

  <div class="seven wide middle column">

    <table border="1" id="myTable" class="ui compact table segment">
      <tr>
        <td colspan="3">
          <textarea id="inputTextToSave" style="width:90%;height:400px"></textarea>
        </td>
      </tr>
      <tr>
        <td id="hint" nowrap="nowrap">Select a POS data to Load:</td>
        <td>
          <input type="file" id="fileToLoad" onchange="LoadFileAsText()">
        </td>
      </tr>
    </table>
    <div class="ui button" id="load" onclick="ShowPOSInfo()">Load</div>
  </div>

  <div class="nine wide right column">
    <div id="countryCode">POS country code
      <input type="text" name="countryCode" id="nationCode">
    </div>

    <div id="POSInfo">
      <h1 id="header" class="ui header">Point of servers Information</h1>
      <table border="1" id="POSTable" class="tablesorter">
        <tr>
          <th>Id</th>
          <th>District</th>
          <th>Latitude</th>
          <th>Longitude</th>
        </tr>
      </table>
    </div>
  </div>
</div>

{% endblock %}

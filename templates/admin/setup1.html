<!--
  Copyright (c) 2012-2015  Sinica IIS Openisdm MAD

  Project Name:

    MAD-IS

  File Name:

    setup1.html

  Abstract:

    This page allow user to setup the city that he/she want to serve or 
    create new one if there have none to choose.

  Authors:

    Bai Shan-Wei
-->


<!--HTML Header-->
{% extends 'admin/master.html' %} {% block head_tail %} {{ super() }}

<script src="http://cdnjs.cloudflare.com/ajax/libs/jquery/2.0.3/jquery.js"></script>

<script src="https://maps.googleapis.com/maps/api/js?v=3.exp&libraries=places&key=AIzaSyC0MXBPQYPcc3IAhEJJdCDE6bGPhFobPHo&sensor=false"></script>


<style>
  
  html, body , .container, #map-canvas {
    height: 100%;
  }
</style>

{% endblock %}
<!--END-->

<!--HTML Body-->
{% block body %}
<script type='text/javascript'>


/**
 * @param {Object} [obj]  Json obj
 * @param {String} [countryName] Record country name
 * @param {String} [cityName] Record city name
 * @param {String} [setupText] Record text that will be sent to server for storing in the database
 * @param {Boolean} [findCountry] Check if user fine country that need to serve.
 */

/*
  Description : 
    This function initialize Ui elements property and requst the Server for information.
---------------------------------------------------------------------------------------------------------------*/
function initialize() {
  loadMap();
  myLocation = "";
  var markers = [];
  var input = (document.getElementById('pac-input'));
  map.controls[google.maps.ControlPosition.TOP_LEFT].push(input);

  var searchBox = new google.maps.places.SearchBox((input));


  google.maps.event.addListener(searchBox, 'places_changed', function() {
      var places = searchBox.getPlaces();

      if (places.length == 0) {
        return;
      }
      for (var i = 0, marker; marker = markers[i]; i++) {
        marker.setMap(null);
      }

      // For each place, get the icon, place name, and location.
      markers = [];
      var bounds = new google.maps.LatLngBounds();
      for (var i = 0, place; place = places[i]; i++) {
        var image = {
          url: place.icon,
          size: new google.maps.Size(71, 71),
          origin: new google.maps.Point(0, 0),
          anchor: new google.maps.Point(17, 34),
          scaledSize: new google.maps.Size(25, 25)
        };

        // Create a marker for each place.
        var marker = new google.maps.Marker({
          map: map,
          icon: image,
          title: place.name,
          position: place.geometry.location
        });

        markers.push(marker);

        myLocation = (place.geometry.location.toString()).replace(/[\])}[{(]/g, "");
        map.setCenter(place.geometry.location);
        map.setZoom(12);
      }
    });
}
/*-------------------------------------------------------------------------------------------------------------*/


function loadMap(){
  map = new google.maps.Map(document.getElementById('map-canvas'), {
      mapTypeId: google.maps.MapTypeId.ROADMAP,
      zoom: 2,
      minZoom: 2,
      maxZoom: 21,
      center: new google.maps.LatLng(0, 0)
  });
}

/*---------------------------------------------------------------------------------------------------------------*/

/*
  Description : 
    This function describe that post text to sever after finishing settting, 
    and jump to next page.
---------------------------------------------------------------------------------------------------------------*/

function NextStep() {
  var isVaidate = ValidateForm();
  if (isVaidate) {
    setupText = 'location$' + myLocation;
    var hr = new XMLHttpRequest();
    var serverUrl = "http://140.109.22.197/send/";
    hr.open("POST", serverUrl, true);
    hr.send(setupText);

    setTimeout('window.location.replace("http://140.109.22.197/admin/setup/step2")', 2000);
  } else {
    alert('Forms must be filled out');
  }
}
/*-------------------------------------------------------------------------------------------------------------*/

/*
  Description : 
    This function describe that check whether user have fill in forms or not.
---------------------------------------------------------------------------------------------------------------*/

function ValidateForm() {
  if (myLocation == null || myLocation == "") {
    return false;
  }
  return true;
}
/*-------------------------------------------------------------------------------------------------------------*/

google.maps.event.addDomListener(window, 'load', initialize);

</script>
<body>

<div id="next" class="ui button" style="float: right" onclick="NextStep()">Next</div>
<input id="pac-input" class="controls" type="text" placeholder="Search Box" style="width: 400px;margin: 25px 11px 0 13px">
<div id="map-canvas" style="width:90%"></div>

</body>

{% endblock %}
<!--END-->

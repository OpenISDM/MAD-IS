<!--
  Copyright (c) 2012-2015  Sinica IIS Openisdm MAD

  Project Name:

    MAD-IS

  File Name:

    setup3.html

  Abstract:

    This page allow user to insert POS Server information, such as their location, ID and MAC-Address
    and Show the result to let user check if it inputed right.

  Authors:

    Bai Shan-Wei
-->

<!--HTML Header-->
{% extends 'admin/cityView.html' %} {% block head_tail %} {{ super() }}
<link type="text/css" href="/static/css/bar.css" rel="stylesheet">
<script src="http://cdnjs.cloudflare.com/ajax/libs/jquery/2.0.3/jquery.js"></script>
<script type="text/javascript" src="/static/javascript/jquery.tablesorter.js"></script>
{% endblock %}
<!--END-->

<!--HTML Body-->
{% block body %}


<script type='text/javascript'>
/**
 * @param {String} [xmlData] Record xml text for parsing
 * @param {Object} [region] Region object
 * @param {Object} [region.name] District name
 * @param {Object} [region.postalCode] Postal code that be express assigned district
 * @param {Object} [pos] POS object
 * @param {Object} [pos.special_id] ID for certification
 * @param {Object} [pos.ward] District that POS locate
 * @param {Object} [pos.lat] A geographic coordinate that specifies the north-south position of a POS
 * @param {Object} [pos.lng] A geographic coordinate that specifies the east-west position of a POS
 * @param {String} [posText] Record text that will be sent to server for storing in the database
 */

/*
   Description : 
    This function initialize Ui elements property and requst the Server for information.
/*--------------------------------------------------------------------------------------------------------------*/
$(document).ready(function() {
  $("#pos_bar").hide();
  ReqServer();
});
/*-------------------------------------------------------------------------------------------------------------*/

/*
  Description : 
    This function describe that it request server for geographical information, and Server will
    response it, then record each region's properties.
/*--------------------------------------------------------------------------------------------------------------*/

function ReqServer() {
  region = [];

  var xmlhttp;
  if (window.XMLHttpRequest) {
    // code for IE7+, Firefox, Chrome, Opera, Safari
    xmlhttp = new XMLHttpRequest();
  } else {
    // code for IE6, IE5
    xmlhttp = new ActiveXObject("Microsoft.XMLHTTP");
  }
  xmlhttp.onreadystatechange = function() {
    if (xmlhttp.readyState == 4 && xmlhttp.status == 200) {

      //Receive region information from server's response
      var regionInfo = xmlhttp.responseText;

      //Add "()" and become json string for parsing
      var obj = eval("(" + regionInfo + ")");
      for (var i = 0; i < obj.data.length; i++) {

        //Create new object to record each region properties and push into an array.
        var area = new Object();
        area.name = obj.data[i].District;
        area.postalCode = obj.data[i].Code;
        region.push(area);
      }
    }
  }
  xmlhttp.open("POST", "http://140.109.22.197/fetch/", true);
  xmlhttp.send('geoInfo');
}

/*--------------------------------------------------------------------------------------------------------------*/

/*
  Description : 
    This function describe that store the text from loading user's computer xml file.
----------------------------------------------------------------------------------------------------------------*/

function LoadFileAsText() {
  var fileToLoad = document.getElementById("fileToLoad").files[0];

  var fileReader = new FileReader();
  fileReader.onload = function(fileLoadedEvent) {
    var textFromFileLoaded = fileLoadedEvent.target.result;
    document.getElementById("inputTextToSave").value = textFromFileLoaded;
    xmlData = textFromFileLoaded;
  }
  fileReader.readAsText(fileToLoad, "UTF-8");
}
/*--------------------------------------------------------------------------------------------------------------*/

/*
  Description : 
    This function describe that parse xml string and get POS servers attribution values,
    then use these valuses to creat data table about POS servers
----------------------------------------------------------------------------------------------------------------*/

function ShowPOSInfo() {
  pos = [];

  $("#pos_bar").show();
  $("#countryCode").hide();

  if (window.DOMParser) {
    parser = new DOMParser();
    xmlDoc = parser.parseFromString(xmlData, "text/xml");
  } else {
    // Internet Explorer
    xmlDoc = new ActiveXObject("Microsoft.XMLDOM");
    xmlDoc.async = false;
    xmlDoc.loadXML(xmlData);
  }
  var num = 0;
  for (var i = 0; i < xmlDoc.getElementsByTagName("POSSite").length; i=i+50) {

    //Create new object to record each POS properties and push into an array.
    var posObj = new Object();
    posObj.ward = xmlDoc.getElementsByTagName("District")[i].childNodes[0].nodeValue;
    //Create POS server own id
    //posObj.special_id = document.getElementById('nationCode').value + "-" + GetCode(posObj.ward) + "-" + RandomNum();
    posObj.special_id = xmlDoc.getElementsByTagName("ID")[i].childNodes[0].nodeValue;
    posObj.lat = xmlDoc.getElementsByTagName("Latitude")[i].childNodes[0].nodeValue;
    posObj.lng = xmlDoc.getElementsByTagName("Longitude")[i].childNodes[0].nodeValue;
    pos.push(posObj);

    num++;

    BuildposTable(posObj.special_id, posObj.ward, posObj.lat, posObj.lng, num);
  }
}
/*--------------------------------------------------------------------------------------------------------------*/

/*
  Description : 
    This function describe that get postalcode by using district to match.
  Arguments :
    district - A division area that POS server live in.
----------------------------------------------------------------------------------------------------------------*/

function GetCode(district) {
  for (var j = 0; j < region.length; j++) {
    if (district == region[j].name) {
      return region[j].postalCode;
    }
  }
}
/*--------------------------------------------------------------------------------------------------------------*/

/*
  Description : 
    This function describe that use passing values to declare a new row, then add into the data table.
  Arguments : 
    id - POS ID
    area - POS District
    lat - The north-south position of a POS 
    lng - The east-west position of a POS 
----------------------------------------------------------------------------------------------------------------*/

function BuildposTable(id, area, x, y, rowCounts) {
  //Declare a new row
  var tr = $("<tr></tr>").addClass("dynamic_tr").attr("id", "trNo" + rowCounts);

  var td_name = $('<td></td>').text(id).attr("id", "tdName" + rowCounts);
  tr.append(td_name);

  var td_area = $('<td></td>').text(area).attr("id", "td_area" + rowCounts);
  tr.append(td_area);

  var td_lat = $('<td></td>').text(x).attr("id", "td_lat" + rowCounts);
  tr.append(td_lat);

  var td_lng = $('<td></td>').text(y).attr("id", "td_lng" + rowCounts);
  tr.append(td_lng);

  //The row be added to the table 
  $("#posTable").append(tr);

  //Sortable table
  $('#posTable').tablesorter();
}
/*--------------------------------------------------------------------------------------------------------------*/

/*
  Description : 
    This function describe that generate six digits randomly.
  Return Value : 
    A 6-digit number be ragard as partial of POS id.
----------------------------------------------------------------------------------------------------------------*/

function RandomNum() {
  var digit = ""
  for (var i = 0; i < 6; i++) {
    digit += Math.floor(Math.random() * 10);
  }
  return digit;
}
/*--------------------------------------------------------------------------------------------------------------*/

/*
  Description : 
    This function describe that jump to previous page.
-----------------------------------------------------------------------------------------------------------------*/

function BackStep() {
  setTimeout('window.location.replace("http://140.109.22.197/admin/setup/step1")',
    2000);
}
/*---------------------------------------------------------------------------------------------------------------*/


/*
  Description : 
    This function describe that post text to sever after finishing settting, 
    and jump to next page.
----------------------------------------------------------------------------------------------------------------*/

function NextStep() {
  for (var i = 0; i < pos.length; i++) {
    posText = "data$" + "posServer$" + GetPOSInfo(i);

    var hr = new XMLHttpRequest();
    var serverUrl = "http://140.109.22.197/send/";
    hr.open("posT", serverUrl, true);
    hr.send(posText);
  }
  setTimeout('window.location.replace("http://140.109.22.197/admin/")', 10000);
}
/*--------------------------------------------------------------------------------------------------------------*/

/*
  Description : 
    This function describe that store the text from loading user's computer xml file.
  Return Value : 
    allText - The text user inputed will be sent to server.
----------------------------------------------------------------------------------------------------------------*/

function GetPOSInfo(num) {

  //get country code  value from input text form
  //nationCode = document.getElementById('nationCode').value;

  //Combine these POS information and use '$' character to separate
  allText = 'nationCode' + '$' + pos[num].special_id + '$' + pos[num].ward + '$' + pos[num].lat + '$' +
    pos[num].lng;

  return allText;
}
/*--------------------------------------------------------------------------------------------------------------*/
</script>
<!--Header-->
<h2 class="ui header" id="header">Create POS configuration</h2>

<!--Button that can process previous/next page-->
<div id="setupnext" class="ui blue button" style="float: right" onclick="NextStep()">Next</div>
<div style="float: right">&nbsp</div>
<div id="setupback" class="ui blue button" style="float: right" onclick="">Back</div>

<!-- Main component-->
<div class="ui celled grid" style="width:100%;height:100%">
  <!-- Text area at the left hand side,which is used to let user browse the file-->
  <div class="seven wide middle column">
    <table border="1" id="myTable" class="ui compact table segment">
      <tr>
        <td colspan="3">
          <textarea id="inputTextToSave" style="width:90%;height:400px"></textarea>
        </td>
      </tr>
      <tr>
        <td id="hint" nowrap="nowrap">Select a pos data to Load:</td>
        <td>
          <input type="file" id="fileToLoad" onchange="LoadFileAsText()">
        </td>
      </tr>
    </table>
    <!-- Button that show the data table-->
    <div class="ui button" id="load" onclick="ShowPOSInfo()">Load</div>
  </div>

  <div class="nine wide right column">
    <!-- Text form that be inputted country code -->
    <!--<div id="countryCode">pos country code
      <input type="text" name="countryCode" id="nationCode">
    </div>-->

    <!-- POS table content-->
    <div id="pos_bar">
      <h1 id="header" class="ui header">Point of servers Information</h1>
      <table border="1" id="posTable" class="tablesorter">
        <tr>
          <th>Id</th>
          <th>District</th>
          <th>Latitude</th>
          <th>Longitude</th>
        </tr>
      </table>
    </div>
  </div>
</div>

{% endblock %}
<!--END-->

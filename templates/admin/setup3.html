<!--
  Copyright (c) 2012-2015  Sinica IIS Openisdm MAD

  Project Name:

    MAD-IS

  File Name:

    setup3.html

  Abstract:

    This page allow user to insert POS Server information, such as their location, ID and MAC-Address
    and Show the result to let user check if it inputed right.

  Authors:

    Bai Shan-Wei
-->

<!--HTML Header-->
{% extends 'admin/cityView.html' %} {% block head_tail %} {{ super() }}
<link type="text/css" href="/static/css/bar.css" rel="stylesheet">
<script src="http://cdnjs.cloudflare.com/ajax/libs/jquery/2.0.3/jquery.js"></script>
<script type="text/javascript" src="/static/javascript/jquery.tablesorter.js"></script>
<script src="http://maps.googleapis.com/maps/api/js?key=AIzaSyC0MXBPQYPcc3IAhEJJdCDE6bGPhFobPHo&sensor=false">
</script>
{% endblock %}
<!--END-->

<!--HTML Body-->
{% block body %}

<script type='text/javascript'>
/**
 * @param {String} [xmlData] Record xml text for parsing
 * @param {Object} [region] Region object
 * @param {Object} [region.name] District name
 * @param {Object} [region.postalCode] Postal code that be express assigned district
 * @param {Object} [pos] POS object
 * @param {Object} [pos.special_id] ID for certification
 * @param {Object} [pos.ward] District that POS locate
 * @param {Object} [pos.lat] A geographic coordinate that specifies the north-south position of a POS
 * @param {Object} [pos.lng] A geographic coordinate that specifies the east-west position of a POS
 * @param {String} [posText] Record text that will be sent to server for storing in the database
 */

/*
   Description : 
    This function initialize Ui elements property and requst the Server for information.
/*--------------------------------------------------------------------------------------------------------------*/
$(document).ready(function() {
  loadMap();
  $("#pos_bar").hide();
  ReqServer();
});
/*-------------------------------------------------------------------------------------------------------------*/

/*
  Description : 
    This function describe that find google map element and set its propeties.
/*--------------------------------------------------------------------------------------------------------------*/

function loadMap() {
    map = new google.maps.Map(document.getElementById('map_canvas'), {
      zoom: 11,
      maxZoom: 21
    });
  }
  /*-------------------------------------------------------------------------------------------------------------*/

/*
  Description : 
    This function describe that it request server for geographical information, and Server will
    response it, then record each region's properties.
/*--------------------------------------------------------------------------------------------------------------*/

function ReqServer() {
  region = [];

  var xmlhttp;
  if (window.XMLHttpRequest) {
    // code for IE7+, Firefox, Chrome, Opera, Safari
    xmlhttp = new XMLHttpRequest();
  } else {
    // code for IE6, IE5
    xmlhttp = new ActiveXObject("Microsoft.XMLHTTP");
  }
  xmlhttp.onreadystatechange = function() {
    if (xmlhttp.readyState == 4 && xmlhttp.status == 200) {

      //Receive region information from server's response
      var info = xmlhttp.responseText;

      //Add "()" and become json string for parsing
      var obj = eval("(" + info + ")");

      SetCenter(obj.coordinates);

    }
  }
  xmlhttp.open("POST", "http://140.109.22.197/fetch/", true);
  xmlhttp.send('geoInfo');
}

/*--------------------------------------------------------------------------------------------------------------*/

/*
  Description : 
    This function describe that use geocode api to convert the address into 
    a coordinate(Latitude&Longitude).Then jump that position on google maps
  Arguments : 
    address - The city's location.
/*--------------------------------------------------------------------------------------------------------------*/

function SetCenter(address) {

    //It is the process of finding associated geographic coordinates from other geographic data, 
    //such as street addresses, or ZIP codes (postal codes).
    var geocoder = new google.maps.Geocoder();
    geocoder.geocode({
      'address': address
    }, function(results, status) {
      if (status == google.maps.GeocoderStatus.OK) {
        map.setCenter(results[0].geometry.location);
      }
    });
  }
  /*--------------------------------------------------------------------------------------------------------------*/


/*
  Description : 
    This function describe that store the text from loading user's computer xml file.
----------------------------------------------------------------------------------------------------------------*/

function LoadFileAsText() {
    var fileToLoad = document.getElementById("fileToLoad").files[0];

    var fileReader = new FileReader();
    fileReader.onload = function(fileLoadedEvent) {
      var textFromFileLoaded = fileLoadedEvent.target.result;
      document.getElementById("inputTextToSave").value = textFromFileLoaded;
      xmlData = textFromFileLoaded;
    }
    fileReader.readAsText(fileToLoad, "UTF-8");
  }
  /*--------------------------------------------------------------------------------------------------------------*/

/*
  Description : 
    This function describe that parse xml string and get POS servers attribution values,
    then use these valuses to creat data table about POS servers
----------------------------------------------------------------------------------------------------------------*/

function ShowPOSInfo() {
    pos = [];

    $("#pos_bar").show();
    $("#countryCode").hide();

    if (window.DOMParser) {
      parser = new DOMParser();
      xmlDoc = parser.parseFromString(xmlData, "text/xml");
    } else {
      // Internet Explorer
      xmlDoc = new ActiveXObject("Microsoft.XMLDOM");
      xmlDoc.async = false;
      xmlDoc.loadXML(xmlData);
    }
    var num = 0;
    for (var i = 0; i < xmlDoc.getElementsByTagName("POSSite").length; i = i + 50) {

      //Create new object to record each POS properties and push into an array.
      var posObj = new Object();
      posObj.ward = xmlDoc.getElementsByTagName("District")[i].childNodes[0].nodeValue;
      posObj.special_id = xmlDoc.getElementsByTagName("ID")[i].childNodes[0].nodeValue;
      posObj.lat = xmlDoc.getElementsByTagName("Latitude")[i].childNodes[0].nodeValue;
      posObj.lng = xmlDoc.getElementsByTagName("Longitude")[i].childNodes[0].nodeValue;
      pos.push(posObj);

      num++;

      createMarker(posObj);

    }
  }
  /*--------------------------------------------------------------------------------------------------------------*/
  /*
    Description : 
      This function describe that get postalcode by using district to match.
    Arguments :
      district - A division area that POS server live in.
  ----------------------------------------------------------------------------------------------------------------*/

function GetCode(district) {
    for (var j = 0; j < region.length; j++) {
      if (district == region[j].name) {
        return region[j].postalCode;
      }
    }
  }
  /*--------------------------------------------------------------------------------------------------------------*/

/*
  Description : 
    This function describe that place a marker for identifying a location on a map.
  Arguments : 
    place - The POS or other facilities object.
    placeName - The POS or other facilities name which people get used to call.
---------------------------------------------------------------------------------------------------------------*/

function createMarker(pos) {
    var marker = new google.maps.Marker({
      position: new google.maps.LatLng(pos.lat, pos.lng),
      map: map,
      title: pos.special_id,
    });

    var html = '<div style="width: 240px; height: 50px"><b>' + pos.special_id + '<\/b><br>' + '<\/div>';

    google.maps.event.addListener(marker, 'click', function() {
      if (infoWindow) {
        infoWindow.close();
      }
      infoWindow = new google.maps.InfoWindow({
        content: html
      });
      infoWindow.open(map, marker);
    });
  }
  /*-------------------------------------------------------------------------------------------------------------*/

/*
  Description : 
    This function describe that jump to previous page.
-----------------------------------------------------------------------------------------------------------------*/

function BackStep() {
    setTimeout('window.location.replace("http://140.109.22.197/admin/setup/step2")', 2000);
  }
  /*---------------------------------------------------------------------------------------------------------------*/

/*
  Description : 
    This function describe that post text to sever after finishing settting, 
    and jump to next page.
----------------------------------------------------------------------------------------------------------------*/

function NextStep() {
    for (var i = 0; i < pos.length; i++) {
      posText = "data$" + "posServer$" + GetPOSInfo(i);

      var hr = new XMLHttpRequest();
      var serverUrl = "http://140.109.22.197/send/";
      hr.open("posT", serverUrl, true);
      hr.send(posText);
    }
    setTimeout('window.location.replace("http://140.109.22.197/admin/")', 10000);
  }
  /*--------------------------------------------------------------------------------------------------------------*/

/*
  Description : 
    This function describe that store each text from loading user's computer xml file and these values combine the string .
  Return Value : 
    allText - The text user inputed will be sent to server.
----------------------------------------------------------------------------------------------------------------*/

function GetPOSInfo(num) {

    //Combine these POS information and use '$' character to separate
    allText = 'nationCode' + '$' + pos[num].special_id + '$' + pos[num].ward + '$' + pos[num].lat + '$' +
      pos[num].lng;

    return allText;
  }
  /*--------------------------------------------------------------------------------------------------------------*/
</script>
<!--Header-->
<h2 class="ui header" id="header">Create POS configuration</h2>

<!--Button that can process previous/next page-->
<div id="setupnext" class="ui blue button" style="float: right" onclick="NextStep()">Next</div>
<div style="float: right">&nbsp</div>
<div id="setupback" class="ui blue button" style="float: right" onclick="BackStep()">Back</div>



<!-- Main component-->
<div class="ui celled grid" style="width:100%;height:700px">
  <!-- Map element at the left hand side-->
  <div class="eight wide column">
    <div id="map_canvas" style="height:100%;"></div>
  </div>

  <!-- Form at the left hand side-->
  <div class="eight wide column">
    <table border="1" id="myTable" class="ui compact table segment">
      <tr>
        <td colspan="3">
          <textarea id="inputTextToSave" placeholder="Please import file for POS servers information" style="width:90%; height:400px; resize:none"></textarea>
        </td>
      </tr>
      <tr>
        <td id="hint" nowrap="nowrap">Select a File to Load:</td>
        <td>
          <input type="file" id="fileToLoad" onchange="LoadFileAsText()">
        </td>
      </tr>
    </table>
    <div class="ui button" id="load" onclick="ShowPOSInfo()">Load</div>
  </div>
</div>


{% endblock %}
<!--END-->

<!--
  Copyright (c) 2012-2015  Sinica IIS Openisdm MAD

  Project Name:

    MAD-IS

  File Name:

    setup2.html

  Abstract:

    This page allow user to insert city information, such as District, Border and origin coorinate, 
    and Show the result to let user check if it inputed right.

  Authors:

    Bai Shan-Wei
-->

<!--HTML Header-->
{% extends 'admin/master.html' %} {% block head_tail %} {{ super() }}

<script src="http://cdnjs.cloudflare.com/ajax/libs/jquery/2.0.3/jquery.js"></script>
<script src="http://maps.googleapis.com/maps/api/js?key=AIzaSyC0MXBPQYPcc3IAhEJJdCDE6bGPhFobPHo&sensor=false">
</script>
<script type="text/javascript" src="/static/javascript/v3_ll_grat.js"></script>
{% endblock %}
<!--END-->

<!--HTML Body-->
{% block body %}
<script type='text/javascript'>
/**
 * @param {String} [xmlText] Record xml text for parsing
 * @param {String} [countryName] Record country name
 * @param {String} [cityName] Record city name
 * @param {String} [setupText] Record text that will be sent to server for storing in the database
 */
var grid;
/*
  Description : 
    This function initialize the google map and grid, then requst the Server for information.
---------------------------------------------------------------------------------------------------------------*/
$(document).ready(function() {
  LoadMap();
  grid = new Graticule(map);
  ReqServer();
});
/*-------------------------------------------------------------------------------------------------------------*/

/*
  Description : 
    This function describe that find google map element and set its propeties.
---------------------------------------------------------------------------------------------------------------*/

function LoadMap() {
  map = new google.maps.Map(document.getElementById('map_canvas'), {
    zoom: 11,
    maxZoom: 21
  });
}
/*-------------------------------------------------------------------------------------------------------------*/

/*
  Description : 
    This function describe that it request server for city information, and Server will
    response it, then show the city view on google maps.
/*--------------------------------------------------------------------------------------------------------------*/

function ReqServer() {
  var xmlhttp;
  if (window.XMLHttpRequest) {
    // code for IE7+, Firefox, Chrome, Opera, Safari
    xmlhttp = new XMLHttpRequest();
  } else {
    // code for IE6, IE5
    xmlhttp = new ActiveXObject("Microsoft.XMLHTTP");
  }
  xmlhttp.onreadystatechange = function() {
    if (xmlhttp.readyState == 4 && xmlhttp.status == 200) {
      //Receive city information from server's response
      var cityfo = xmlhttp.responseText;

      //Add "()" and become json string for parsing
      var obj = eval("(" + cityfo + ")");
      cityName = obj.city;
      SetCenter(cityName);
    }
  }
  xmlhttp.open("POST", "http://140.109.22.197/fetch/", true);
  xmlhttp.send('cityInfo');
}
/*--------------------------------------------------------------------------------------------------------------*/

/*
  Description : 
    This function describe that use geocode api to convert the address into 
    a coordinate(Latitude&Longitude).Then jump that position on google maps
  Arguments : 
    address - The city's location.
/*--------------------------------------------------------------------------------------------------------------*/

function SetCenter(address) {

  /*It is the process of finding associated geographic coordinates from other geographic data, 
  such as street addresses, or ZIP codes (postal codes).*/
  var geocoder = new google.maps.Geocoder();
  geocoder.geocode({
    'address': address
  }, function(results, status) {
    if (status == google.maps.GeocoderStatus.OK) {
      map.setCenter(results[0].geometry.location);
    }
  });
}
/*--------------------------------------------------------------------------------------------------------------*/

/*
  Description : 
    This function describe that store the text from loading user's computer xml file.
----------------------------------------------------------------------------------------------------------------*/

function LoadFileAsText() {
  var fileToLoad = document.getElementById("fileToLoad").files[0];

  var fileReader = new FileReader();
  fileReader.onload = function(fileLoadedEvent) {
    var textFromFileLoaded = fileLoadedEvent.target.result;
    document.getElementById("inputTextToSave").value = textFromFileLoaded;
    xmlText = textFromFileLoaded;
  };
  fileReader.readAsText(fileToLoad, "UTF-8");
}
/*---------------------------------------------------------------------------------------------------------------*/


/*
  Description : 
    This function describe that jump to previous page.
-----------------------------------------------------------------------------------------------------------------*/

function BackStep() {
  setTimeout('window.location.replace("http://140.109.22.197/admin/setup/step1")',
    2000);
}
/*---------------------------------------------------------------------------------------------------------------*/


/*
  Description : 
    This function describe that post text to sever after finishing settting, 
    and jump to next page.
-----------------------------------------------------------------------------------------------------------------*/

function NextStep() {
  setupText = Get_AllElement_Val();

  var hr = new XMLHttpRequest();
  var serverUrl = "http://140.109.22.197/send/";
  hr.open("POST", serverUrl, true);
  hr.send(setupText);

  setTimeout('window.location.replace("http://140.109.22.197/admin/setup/step3")',
    2000);
}
/*---------------------------------------------------------------------------------------------------------------*/

/*
  Description : 
    This function describe that the information about boundary and district 
    after user have written the form and click "load" button.
-----------------------------------------------------------------------------------------------------------------*/

function ShowCityInfo() {
  var isVaidate = ValidateForm();
  if (isVaidate == true) {
    $("#countryInfo").hide();
    ShowBoundary(document.getElementById('key').value);
    ShowWardBtn();
    CreateMarker();
  } else {
    alert('Forms must be filled out');
  }
}
/*---------------------------------------------------------------------------------------------------------------*/

function ValidateForm() {

  wardInfo = document.getElementById("inputTextToSave").value;
  latLng = document.getElementById('latLng').value;
  if (wardInfo == null || wardInfo == "" || latLng == null || latLng == "") {
    return false;
  } else {
    return true;
  }
}
/*---------------------------------------------------------------------------------------------------------------*/
/*
  Description : 
    This function describe that google maps show border about the city when using the key 
    to load fusion table content.
  Arguments : 
    key - Fusion table id that user have inputed.
-----------------------------------------------------------------------------------------------------------------*/

function ShowBoundary(key) {
  borderlayer = new google.maps.FusionTablesLayer({
    query: {
      select: 'null',
      from: key
    },
    map: map,
    suppressInfoWindows: true
  });
}
/*---------------------------------------------------------------------------------------------------------------*/

/*
  /*
  Description : 
    This function describe that place a marker for identifying the origin point of city location.
-----------------------------------------------------------------------------------------------------------------*/

function CreateMarker() {
  var latLng = (document.getElementById('latLng').value).split(",");
  var marker = new google.maps.Marker({
    position: new google.maps.LatLng(latLng[0], latLng[1]),
    map: map,
    title: 'Origin of coordinate',
  });
}
/*---------------------------------------------------------------------------------------------------------------*/

/*
  Description : 
    This function describe that parse xml string and get district and postal code values, 
    and use these values to regard as new button name.
-----------------------------------------------------------------------------------------------------------------*/

function ShowWardBtn() {
  if (window.DOMParser) {
    parser = new DOMParser();
    xmlDoc = parser.parseFromString(xmlText, "text/xml");
  } else {
    // Internet Explorer
    xmlDoc = new ActiveXObject("Microsoft.XMLDOM");
    xmlDoc.async = false;
    xmlDoc.loadXML(xmlText);
  }

  for (var i = 0; i < xmlDoc.getElementsByTagName("District").length; i++) {
    //Fetch District value and Postal Code value
    region = xmlDoc.getElementsByTagName("Name")[i].childNodes[0].nodeValue;
    code = xmlDoc.getElementsByTagName("PostalCode")[i].childNodes[0].nodeValue;

    //Declare a New button and set properties
    var ward_btn = $('<button></button' + '<br></br>').text(region + code).attr(
      "id", region);

    //Google map jump to District Scene when click the button.
    ward_btn.click(function() {
      SetCenter(cityName + $(this).attr("id"));
      map.setZoom(13);
    });

    $("#myward").append(ward_btn);
  }
}
/*---------------------------------------------------------------------------------------------------------------*/

/*
 Description : 
    This function describe that combine all input text after user have chosen option or 
    have inputed the form.
  Return Value : 
    allText - The text user inputed will be sent to server.
-----------------------------------------------------------------------------------------------------------------*/

function Get_AllElement_Val() {
  coordinatesText = document.getElementById('latLng').value;
  keyText = document.getElementById('key').value;

  //Combine these texts and use '$' character to separate
  allText = 'geo' + '$' + coordinatesText + '$' + keyText + '$' + xmlText;

  return allText;
}

/*---------------------------------------------------------------------------------------------------------------*/
</script>
<!--Header-->
<h2 class="ui header" id="header">Create your city configuration</h2>

<!--Button that can process previous/next page-->
<div id="setupnext" class="ui blue button" style="float: right" onclick="NextStep()">Next</div>
<div style="float: right">&nbsp</div>
<div id="setupback" class="ui blue button" style="float: right" onclick="BackStep()">Back</div>

<!-- Main component-->
<div class="ui celled grid">
  <!-- Map element at the left hand side-->
  <div class="eight wide middle column">
    <div id="map_canvas" style="height:650px;"></div>
  </div>

  <!-- Form at the left hand side-->
  <div class="ten wide middle column">
    <div id="myward"></div>
    <div id="countryInfo">
      <b>District Information</b>
      <table border="1" id="myTable" class="ui compact table segment">
        <tr>
          <td colspan="3">
            <textarea id="inputTextToSave" style="width:90%;height:400px"></textarea>
          </td>
        </tr>
        <tr>
          <td id="hint" nowrap="nowrap">Select a File to Load:</td>
          <td>
            <input type="file" id="fileToLoad" onchange="LoadFileAsText()">
          </td>
        </tr>
      </table>
      <b>Fusion table ID</b>
      <input type="text" name="apikey" id="key">
      <br>
      <b>Origin Of Coordinates</b>
      <input type="text" name="coordinates" id="latLng">
      <br>
      <div id="load" class="ui blue button" style="float: right" onclick="ShowCityInfo()">Load</div>
    </div>
  </div>
</div>

{% endblock %}
<!--END-->
